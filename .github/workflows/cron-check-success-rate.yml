# ğŸ”¥ è€ç‹å®ç°ï¼šGitHub Actions å®šæ—¶ä»»åŠ¡ - æ£€æŸ¥æˆåŠŸç‡
#
# ç”¨é€”ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹ï¼ˆUTCï¼‰æ£€æŸ¥APIæˆåŠŸç‡
# æ›¿ä»£ï¼šåŸVercel Cron Jobï¼ˆå› å…è´¹è®¡åˆ’é™åˆ¶è¢«ç¦ç”¨ï¼‰
#
# é…ç½®è¯´æ˜ï¼š
# 1. åœ¨GitHubä»“åº“çš„ Settings > Secrets and variables > Actions ä¸­æ·»åŠ ï¼š
#    - CRON_SECRET: Cronä»»åŠ¡å¯†é’¥ï¼ˆä¸ç”Ÿäº§ç¯å¢ƒ .env ä¸­çš„ CRON_SECRET ç›¸åŒï¼‰
#    - PRODUCTION_URL: ç”Ÿäº§ç¯å¢ƒURLï¼ˆå¦‚ https://your-app.vercel.appï¼‰
#
# 2. ç¡®ä¿ç”Ÿäº§ç¯å¢ƒçš„ .env ä¸­é…ç½®äº†ç›¸åŒçš„ CRON_SECRET

name: æ£€æŸ¥æˆåŠŸç‡ (æ¯å¤©å‡Œæ™¨2ç‚¹UTC)

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹ï¼ˆUTCï¼‰= åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹
    - cron: '0 2 * * *'

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  check-success-rate:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š æ£€æŸ¥æˆåŠŸç‡
        run: |
          echo "ğŸ”„ å¼€å§‹æ£€æŸ¥APIæˆåŠŸç‡..."
          echo "æ‰§è¡Œæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.PRODUCTION_URL }}/api/cron/check-success-rate" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTPçŠ¶æ€ç : $HTTP_CODE"
          echo "å“åº”å†…å®¹:"
          echo "$BODY" | jq '.' || echo "$BODY"

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… æˆåŠŸç‡æ£€æŸ¥å®Œæˆ"
            exit 0
          else
            echo "âŒ æˆåŠŸç‡æ£€æŸ¥å¤±è´¥ (HTTP $HTTP_CODE)"
            exit 1
          fi
